<script setup>
import { ref, onMounted } from 'vue'
import { request } from '@/common/request'
import { 
    Spin, 
    message, 
    Card, 
    Button, 
    List, 
    Badge, 
    Descriptions, 
    Space, 
    Typography,
    Progress,
    Input,
    Form
} from 'ant-design-vue'
import { invoke } from '@tauri-apps/api/core'

const { Title, Text } = Typography

const emit = defineEmits(['inited'])

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const loading = ref(true)
const scanStatus = ref('Ê≠£Âú®Ëé∑ÂèñÊú¨Êú∫IPÂú∞ÂùÄ...')
const networkInfo = ref(null)
const foundDevices = ref([])
const scanProgress = ref({
    current: 0,
    total: 256,
    currentIP: '',
    phase: ''
})
const manualIP = ref('192.168.1.7') // ÈªòËÆ§ËÆæÁΩÆ‰∏∫Áî®Êà∑ÊèêÂà∞ÁöÑIP

// Ëé∑ÂèñÊú¨Êú∫IPÂú∞ÂùÄ
const getLocalIP = async () => {
    try {
        scanStatus.value = 'Ê≠£Âú®Ëé∑ÂèñÊú¨Êú∫IPÂú∞ÂùÄ...'
        const result = await invoke('get_local_ip')
        networkInfo.value = result
        console.log('Êú¨Êú∫IP‰ø°ÊÅØ:', result)
        return result
    } catch (error) {
        console.error('Ëé∑ÂèñÊú¨Êú∫IPÂ§±Ë¥•:', error)
        message.error('Ëé∑ÂèñÊú¨Êú∫IPÂ§±Ë¥•: ' + error)
        return null
    }
}

// Ê£ÄÊü•ËÆæÂ§áÊòØÂê¶‰∏∫È£ûÊú∫
const checkDroneDevice = async (ip) => {
    try {
        console.log(`Ê≠£Âú®Ê£ÄÊµãÈ£ûÊú∫ËÆæÂ§á: ${ip}:80`)
        
        // Âè™Â∞ùËØïËÆøÈóÆÈ£ûÊú∫ÁöÑÊâ´ÊèèÊé•Âè£ /scan (Á´ØÂè£80)
        const response = await request({ 
            url: `http://${ip}/scan`,
            timeout: 2000
        })
        
        if (response) {
            console.log(`‚úÖ ÂèëÁé∞È£ûÊú∫ËÆæÂ§á: ${ip}:80`, response)
            return { ip, isActive: true, response, port: 80 }
        }
    } catch (error) {
        console.log(`‚ùå ËÆæÂ§á ${ip}:80 Êó†ÂìçÂ∫î`)
    }
    return null
}

// Êâ´ÊèèÁΩëÊÆµ‰∏≠ÁöÑÊâÄÊúâIPÔºà0-255ÔºâÔºåÊâæÂà∞‰∏Ä‰∏™Â∞±ÂÅúÊ≠¢
const scanNetworkRange = async (networkBase) => {
    scanStatus.value = `Ê≠£Âú®Êâ´ÊèèÁΩëÊÆµ ${networkBase}.0-255`
    scanProgress.value.current = 0
    scanProgress.value.total = 256
    scanProgress.value.phase = 'Êâ´ÊèèIPÂú∞ÂùÄ'
    
    // ÊâæÂà∞Á¨¨‰∏Ä‰∏™È£ûÊú∫Â∞±ÂÅúÊ≠¢Êâ´Êèè
    for (let i = 0; i < 256; i++) {
        const ip = `${networkBase}.${i}`
        scanProgress.value.currentIP = ip
        scanProgress.value.current = i + 1
        
        // Ë∑≥ËøáÊú¨Êú∫IP
        if (ip === networkInfo.value?.ip_address) {
            continue
        }
        
        console.log(`Êâ´ÊèèËøõÂ∫¶: ${i + 1}/256 - Ê≠£Âú®Ê£ÄÊµã ${ip}`)
        
        const result = await checkDroneDevice(ip)
        if (result) {
            console.log(`üéâ ÊâæÂà∞È£ûÊú∫ËÆæÂ§áÔºåÂÅúÊ≠¢Êâ´Êèè: ${result.ip}:${result.port}`)
            message.success(`ÂèëÁé∞È£ûÊú∫ËÆæÂ§á: ${result.ip}:${result.port}`)
            return [result] // ËøîÂõûÊâæÂà∞ÁöÑËÆæÂ§áÔºåÂÅúÊ≠¢Êâ´Êèè
        }
    }
    
    return [] // Êâ´ÊèèÂÆåÊï¥‰∏™ÁΩëÊÆµÈÉΩÊ≤°ÊâæÂà∞
}

// ÊâãÂä®Ê£ÄÊµãÊåáÂÆöIP
const checkManualIP = async () => {
    if (!manualIP.value) {
        message.error('ËØ∑ËæìÂÖ•IPÂú∞ÂùÄ')
        return
    }
    
    loading.value = true
    scanStatus.value = `Ê≠£Âú®Ê£ÄÊµãÊâãÂä®ËæìÂÖ•ÁöÑIP: ${manualIP.value}`
    
    try {
        const result = await checkDroneDevice(manualIP.value)
        if (result) {
            foundDevices.value = [result]
            message.success(`ÊàêÂäüËøûÊé•Âà∞È£ûÊú∫: ${result.ip}:${result.port}`)
        } else {
            message.warning(`IP ${manualIP.value} Êó†Ê≥ïËØÜÂà´‰∏∫È£ûÊú∫ËÆæÂ§á`)
        }
    } catch (error) {
        message.error('Ê£ÄÊµãÂ§±Ë¥•: ' + error)
    } finally {
        loading.value = false
    }
}

// ‰∏ªÊâ´ÊèèÂáΩÊï∞
const scanNet = async () => {
    try {
        loading.value = true
        
        // 1. Ëé∑ÂèñÊú¨Êú∫IP
        const localIP = await getLocalIP()
        if (!localIP) {
            scanStatus.value = 'Êó†Ê≥ïËé∑ÂèñÊú¨Êú∫IPÂú∞ÂùÄ'
            return
        }
        
        scanStatus.value = `Êú¨Êú∫IP: ${localIP.ip_address}ÔºåÂáÜÂ§áÊâ´ÊèèÁΩëÊÆµ ${localIP.network_base}.0-255`
        
        // 2. Êâ´ÊèèÊï¥‰∏™ÁΩëÊÆµ (0-255)
        const drones = await scanNetworkRange(localIP.network_base)
        
        if (drones.length > 0) {
            scanStatus.value = `ÊâæÂà∞È£ûÊú∫ËÆæÂ§áÔºåÂÅúÊ≠¢Êâ´Êèè`
            // Ëá™Âä®ËøûÊé•ÊâæÂà∞ÁöÑÈ£ûÊú∫
            message.success(`Ëá™Âä®ËøûÊé•Âà∞È£ûÊú∫: ${drones[0].ip}:${drones[0].port}`)
            emit('inited', drones[0])
        } else {
            scanStatus.value = 'Êâ´ÊèèÂÆåÊàêÔºåÊú™ÂèëÁé∞È£ûÊú∫ËÆæÂ§á'
            message.warning(`Âú®ÁΩëÊÆµ ${localIP.network_base}.0-255 ‰∏≠Êú™ÂèëÁé∞È£ûÊú∫ËÆæÂ§á`)
        }
        
    } catch (error) {
        console.error('Êâ´ÊèèÂ§±Ë¥•:', error)
        message.error('Êâ´ÊèèÂ§±Ë¥•: ' + error)
        scanStatus.value = 'Êâ´ÊèèÂ§±Ë¥•'
    } finally {
        loading.value = false
    }
}

// ÊâãÂä®ÈáçÊñ∞Êâ´Êèè
const rescan = () => {
    foundDevices.value = []
    scanProgress.value = { current: 0, total: 256, currentIP: '', phase: '' }
    scanNet()
}

// ËøûÊé•È£ûÊú∫
const connectDrone = (device) => {
    message.success(`ËøûÊé•Âà∞È£ûÊú∫: ${device.ip}:${device.port || 80}`)
    emit('inited', device)
}

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂ÂºÄÂßãÊâ´Êèè
onMounted(() => {
    scanNet()
})
</script>

<template>
    <div style="padding: 24px; max-width: 800px; margin: 0 auto;">
        <Spin size="large" :spinning="loading" :tip="scanStatus">
            <Space direction="vertical" size="large" style="width: 100%;">
                
                <!-- ÊâãÂä®ËæìÂÖ•IP -->
                <Card title="ÊâãÂä®ËøûÊé•È£ûÊú∫" size="small">
                    <Form layout="inline">
                        <Form.Item label="È£ûÊú∫IPÂú∞ÂùÄ">
                            <Input 
                                v-model:value="manualIP" 
                                placeholder="‰æãÂ¶Ç: 192.168.1.7"
                                style="width: 200px;"
                            />
                        </Form.Item>
                        <Form.Item>
                            <Button type="primary" @click="checkManualIP" :loading="loading">
                                ËøûÊé•
                            </Button>
                        </Form.Item>
                    </Form>
                </Card>
                
                <!-- Êâ´ÊèèËøõÂ∫¶ÊòæÁ§∫ -->
                <Card v-if="loading && scanProgress.total > 0" title="Êâ´ÊèèËøõÂ∫¶" size="small">
                    <Space direction="vertical" style="width: 100%;">
                        <Progress 
                            :percent="Math.round((scanProgress.current / scanProgress.total) * 100)"
                            :status="loading ? 'active' : 'success'"
                        />
                        <Descriptions size="small" :column="1">
                            <Descriptions.Item label="Êâ´ÊèèÈò∂ÊÆµ">
                                {{ scanProgress.phase }}
                            </Descriptions.Item>
                            <Descriptions.Item label="ÂΩìÂâçIP">
                                <Text code>{{ scanProgress.currentIP }}</Text>
                            </Descriptions.Item>
                            <Descriptions.Item label="ËøõÂ∫¶">
                                {{ scanProgress.current }} / {{ scanProgress.total }}
                            </Descriptions.Item>
                        </Descriptions>
                    </Space>
                </Card>
                
                <!-- Êú¨Êú∫IP‰ø°ÊÅØ -->
                <Card v-if="networkInfo" title="Êú¨Êú∫IP‰ø°ÊÅØ" size="small">
                    <Descriptions size="small" :column="2">
                        <Descriptions.Item label="Êú¨Êú∫IP">
                            <Text code>{{ networkInfo.ip_address }}</Text>
                        </Descriptions.Item>
                        <Descriptions.Item label="Êâ´ÊèèÁΩëÊÆµ">
                            <Text code>{{ networkInfo.network_base }}.0-255</Text>
                        </Descriptions.Item>
                    </Descriptions>
                </Card>
                
                <!-- ÂèëÁé∞ÁöÑÈ£ûÊú∫ËÆæÂ§á -->
                <Card v-if="foundDevices.length > 0" size="small">
                    <template #title>
                        <Space>
                            <Title :level="4" style="margin: 0;">ÂèëÁé∞ÁöÑÈ£ûÊú∫ËÆæÂ§á</Title>
                            <Badge :count="foundDevices.length" show-zero style="background-color: #52c41a;" />
                        </Space>
                    </template>
                    
                    <List 
                        :data-source="foundDevices" 
                        size="small"
                    >
                        <template #renderItem="{ item }">
                            <List.Item>
                                <template #actions>
                                    <Button type="primary" size="small" @click="connectDrone(item)">
                                        ËøûÊé•
                                    </Button>
                                </template>
                                <List.Item.Meta>
                                    <template #title>
                                        <Space>
                                            <Text strong>{{ item.ip }}:{{ item.port || 80 }}</Text>
                                            <Badge status="success" text="Âú®Á∫ø" />
                                        </Space>
                                    </template>
                                    <template #description>
                                        È£ûÊú∫ËÆæÂ§á - {{ item.path || '/scan' }} Êé•Âè£ÂèØËÆøÈóÆ
                                    </template>
                                </List.Item.Meta>
                            </List.Item>
                        </template>
                    </List>
                </Card>
                
                <!-- Êìç‰ΩúÊåâÈíÆ -->
                <Card v-if="!loading" size="small">
                    <Space style="width: 100%; justify-content: center;">
                        <Button type="default" @click="rescan" :loading="loading">
                            ÈáçÊñ∞Êâ´ÊèèÊï¥‰∏™ÁΩëÊÆµ (0-255)
                        </Button>
                    </Space>
                </Card>
                
                <!-- Á©∫Áä∂ÊÄÅÊèêÁ§∫ -->
                <Card v-if="!loading && foundDevices.length === 0 && networkInfo" size="small">
                    <div style="text-align: center; padding: 40px 0;">
                        <Title :level="4" type="secondary">Êú™ÂèëÁé∞È£ûÊú∫ËÆæÂ§á</Title>
                        <Text type="secondary">Â∑≤Êâ´ÊèèÁΩëÊÆµ {{ networkInfo.network_base }}.0-255</Text>
                        <br>
                        <Text type="secondary">ÊàñËÄÖ‰ΩøÁî®‰∏äÊñπÁöÑÊâãÂä®ËøûÊé•ÂäüËÉΩ</Text>
                        <br><br>
                        <Button type="primary" @click="rescan">
                            ÈáçÊñ∞Êâ´Êèè
                        </Button>
                    </div>
                </Card>
            </Space>
        </Spin>
    </div>
</template>

<style scoped>
/* Âá†‰πé‰∏çÈúÄË¶ÅËá™ÂÆö‰πâCSSÔºåÂÖ®ÈÉ®‰ΩøÁî®antdvÁªÑ‰ª∂ÁöÑÈªòËÆ§Ê†∑Âºè */
</style>